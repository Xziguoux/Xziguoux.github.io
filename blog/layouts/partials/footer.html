{{ if .Site.Params.busuanzi }}
<footer>
  <!-- 社交媒体图标 -->
  <div class="footer-social">
    {{- range $index, $key := .Site.Params.Social -}}
    {{- if hasPrefix $key.icon "simple:" -}}
    <a class="soc" href="{{ $key.url }}" rel="me" title="{{ $key.name }}"><i class="si si-{{ substr $key.icon 7 }}"></i></a>
    {{- else -}}
    <a class="soc" href="{{ $key.url }}" rel="me" title="{{ $key.name }}">{{ template "feathericon" (dict "Icon" $key.icon "UseCDN" .Site.Params.useCDN) }}</a>
    {{- end -}}
    {{- end -}}
  </div>
  
  <!-- 统计信息 -->
  <div class="site-stats">
    <div class="busuanzi-count">
      <span class="site-pv">
        总访问量 
        <span id="busuanzi_container_site_pv" style="display: inline;">
          <span id="busuanzi_value_site_pv">--</span>
        </span>
      </span>
      <span class="divider">|</span>
      <span class="site-uv">
        访客数 
        <span id="busuanzi_container_site_uv" style="display: inline;">
          <span id="busuanzi_value_site_uv">--</span>
        </span>
      </span>
    </div>
  </div>

  <!-- 版权信息 -->
  <div class="footer-info">
    <span>© {{ dateFormat "2006" now }} {{ .Site.Params.author }}</span>
    <span class="divider">|</span>
    <a href="https://github.com/athul/archie">Archie Theme</a>
    <span class="divider">|</span>
    <span>Built with <a href="https://gohugo.io">Hugo</a></span>
  </div>
</footer>

<style>
.site-stats {
  text-align: center;
  margin: 1rem 0;
}

.busuanzi-count {
  display: inline-block;
  font-size: 0.9rem;
  color: inherit;
}

.site-pv,
.site-uv {
  display: inline-block;
  margin: 0 0.5rem;
  color: inherit;
}

.divider {
  color: inherit;
  opacity: 0.5;
  margin: 0 0.5rem;
}

#busuanzi_value_site_pv,
#busuanzi_value_site_uv {
  font-weight: bold;
  margin: 0 0.2rem;
  color: inherit;
}

/* 暗色主题适配 */
@media (prefers-color-scheme: dark) {
  .busuanzi-count,
  .site-pv,
  .site-uv,
  #busuanzi_value_site_pv,
  #busuanzi_value_site_uv {
    color: inherit;
  }
}
</style>

<script>
(function() {
  // 确保脚本只加载一次
  if (window.busuanziInitialized) return;
  window.busuanziInitialized = true;

  function initBusuanzi() {
    const script = document.createElement('script');
    script.src = 'https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js';
    script.async = true;

    // 设置超时
    const timeout = setTimeout(() => {
      console.warn('Busuanzi script load timeout');
      updateDisplay('--');
    }, 5000);

    script.onload = () => {
      clearTimeout(timeout);
      // 给不蒜子一点时间来更新数据
      setTimeout(() => {
        const pv = document.getElementById('busuanzi_value_site_pv');
        const uv = document.getElementById('busuanzi_value_site_uv');
        if (pv && pv.textContent === '') pv.textContent = '0';
        if (uv && uv.textContent === '') uv.textContent = '0';
      }, 500);
    };

    script.onerror = () => {
      clearTimeout(timeout);
      console.error('Failed to load Busuanzi script');
      updateDisplay('--');
    };

    document.body.appendChild(script);
  }

  function updateDisplay(value) {
    ['busuanzi_value_site_pv', 'busuanzi_value_site_uv'].forEach(id => {
      const element = document.getElementById(id);
      if (element && element.textContent === '') {
        element.textContent = value;
      }
    });
  }

  // 在页面加载完成后初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBusuanzi);
  } else {
    initBusuanzi();
  }
})();
</script>

{{ if not hugo.IsServer }}
{{ template "_internal/google_analytics.html" . }}
{{ end }}
{{ end }}
