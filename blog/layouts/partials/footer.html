{{ if .Site.Params.busuanzi }}
<footer>
  <!-- 社交媒体图标 -->
  <div class="footer-social">
    {{- range $index, $key := .Site.Params.Social -}}
    {{- if hasPrefix $key.icon "simple:" -}}
    <a class="soc" href="{{ $key.url }}" rel="me" title="{{ $key.name }}"><i class="si si-{{ substr $key.icon 7 }}"></i></a>
    {{- else -}}
    <a class="soc" href="{{ $key.url }}" rel="me" title="{{ $key.name }}">{{ template "feathericon" (dict "Icon" $key.icon "UseCDN" .Site.Params.useCDN) }}</a>
    {{- end -}}
    {{- end -}}
  </div>
  
  <!-- 统计信息 -->
  <div class="site-stats">
    <div class="busuanzi-count">
      <span id="busuanzi_container_site_pv" style="display: none;">
        总访问量 <span id="busuanzi_value_site_pv">0</span>
      </span>
      <span class="divider">|</span>
      <span id="busuanzi_container_site_uv" style="display: none;">
        访客数 <span id="busuanzi_value_site_uv">0</span>
      </span>
    </div>
  </div>

  <!-- 版权信息 -->
  <div class="footer-info">
    <span>© {{ dateFormat "2006" now }} {{ .Site.Params.author }}</span>
    <span class="divider">|</span>
    <a href="https://github.com/athul/archie">Archie Theme</a>
    <span class="divider">|</span>
    <span>Built with <a href="https://gohugo.io">Hugo</a></span>
  </div>
</footer>

<style>
.site-stats {
  text-align: center;
  margin: 1rem 0;
}

.busuanzi-count {
  display: inline-block;
  font-size: 0.9rem;
  color: inherit;
}

.divider {
  color: inherit;
  opacity: 0.5;
  margin: 0 0.5rem;
}

#busuanzi_value_site_pv,
#busuanzi_value_site_uv {
  font-weight: bold;
  margin: 0 0.2rem;
  color: inherit;
}

/* 暗色主题适配 */
@media (prefers-color-scheme: dark) {
  .busuanzi-count,
  #busuanzi_value_site_pv,
  #busuanzi_value_site_uv {
    color: inherit;
  }
}
</style>

<script>
(function() {
  // 防止重复加载
  if (window.busuanziInitialized) return;
  window.busuanziInitialized = true;

  function loadBusuanziScript() {
    var urls = [
      'https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js',
      'https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js'
    ];
    
    return new Promise((resolve, reject) => {
      function tryLoadScript(index) {
        if (index >= urls.length) {
          reject(new Error('所有CDN源都加载失败'));
          return;
        }

        var script = document.createElement('script');
        script.src = urls[index];
        script.async = true;

        script.onload = () => {
          console.log('不蒜子脚本加载成功');
          resolve();
        };

        script.onerror = () => {
          console.warn(`CDN源 ${urls[index]} 加载失败，尝试下一个源`);
          tryLoadScript(index + 1);
        };

        document.body.appendChild(script);
      }

      tryLoadScript(0);
    });
  }

  function showStatistics() {
    setTimeout(() => {
      var containers = document.querySelectorAll('[id^="busuanzi_container"]');
      containers.forEach(container => {
        if (container) {
          container.style.display = 'inline';
        }
      });

      // 检查是否成功获取到数据
      var pv = document.getElementById('busuanzi_value_site_pv');
      var uv = document.getElementById('busuanzi_value_site_uv');
      
      if ((!pv || !pv.innerText || pv.innerText === '0') && 
          (!uv || !uv.innerText || uv.innerText === '0')) {
        console.warn('未能获取到访问统计数据');
      }
    }, 1000); // 增加延迟时间到1秒
  }

  async function initBusuanzi() {
    try {
      await loadBusuanziScript();
      showStatistics();
    } catch (error) {
      console.error('不蒜子统计初始化失败:', error);
    }
  }

  // 在页面加载完成后初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBusuanzi);
  } else {
    initBusuanzi();
  }
})();
</script>

{{ if not hugo.IsServer }}
{{ template "_internal/google_analytics.html" . }}
{{ end }}
{{ end }}
