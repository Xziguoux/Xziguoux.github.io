{{ if .Site.Params.busuanzi }}
<footer>
  <!-- 社交媒体图标 -->
  <div class="footer-social">
    {{- range $index, $key := .Site.Params.Social -}}
    {{- if hasPrefix $key.icon "simple:" -}}
    <a class="soc" href="{{ $key.url }}" rel="me" title="{{ $key.name }}"><i class="si si-{{ substr $key.icon 7 }}"></i></a>
    {{- else -}}
    <a class="soc" href="{{ $key.url }}" rel="me" title="{{ $key.name }}">{{ template "feathericon" (dict "Icon" $key.icon "UseCDN" .Site.Params.useCDN) }}</a>
    {{- end -}}
    {{- end -}}
  </div>
  
  <!-- 统计信息 -->
  <div class="site-stats">
    <div class="busuanzi-count">
      <span id="busuanzi_container_site_pv">
        总访问量 <span id="busuanzi_value_site_pv">--</span>
      </span>
      <span class="divider">|</span>
      <span id="busuanzi_container_site_uv">
        访客数 <span id="busuanzi_value_site_uv">--</span>
      </span>
    </div>
  </div>

  <!-- 版权信息 -->
  <div class="footer-info">
    <span>© {{ dateFormat "2006" now }} {{ .Site.Params.author }}</span>
    <span class="divider">|</span>
    <a href="https://github.com/athul/archie">Archie Theme</a>
    <span class="divider">|</span>
    <span>Built with <a href="https://gohugo.io">Hugo</a></span>
  </div>
</footer>

<style>
.site-stats {
  text-align: center;
  margin: 1rem 0;
}

.busuanzi-count {
  display: inline-block;
  font-size: 0.9rem;
  color: #666;
}

.divider {
  color: #ddd;
  margin: 0 0.5rem;
}

#busuanzi_value_site_pv,
#busuanzi_value_site_uv {
  font-weight: bold;
  margin: 0 0.2rem;
  transition: opacity 0.3s ease;
}

.loading {
  opacity: 0.5;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var scriptLoaded = false;
  var maxRetries = 3;
  var retryCount = 0;

  // 初始化时添加加载状态
  document.querySelectorAll('[id^="busuanzi_value"]').forEach(function(el) {
    el.classList.add('loading');
  });

  function updateStatistics() {
    document.querySelectorAll('[id^="busuanzi_value"]').forEach(function(el) {
      el.classList.remove('loading');
      if (el.textContent === '') {
        el.textContent = '--';
      }
    });
  }

  function loadBusuanzi() {
    if (scriptLoaded || retryCount >= maxRetries) return;

    var script = document.createElement('script');
    script.src = 'https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js';
    script.async = true;
    
    script.onload = function() {
      scriptLoaded = true;
      // 缩短延迟时间，添加过渡效果
      setTimeout(updateStatistics, 200);
    };
    
    script.onerror = function() {
      retryCount++;
      if (retryCount < maxRetries) {
        setTimeout(loadBusuanzi, 1000); // 减少重试等待时间
      } else if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        updateStatistics();
        document.getElementById('busuanzi_value_site_pv').textContent = '测试中';
        document.getElementById('busuanzi_value_site_uv').textContent = '测试中';
      }
    };
    
    document.body.appendChild(script);
  }

  // 添加页面可见性检测
  var hidden, visibilityChange;
  if (typeof document.hidden !== "undefined") {
    hidden = "hidden";
    visibilityChange = "visibilitychange";
  } else if (typeof document.msHidden !== "undefined") {
    hidden = "msHidden";
    visibilityChange = "msvisibilitychange";
  } else if (typeof document.webkitHidden !== "undefined") {
    hidden = "webkitHidden";
    visibilityChange = "webkitvisibilitychange";
  }

  function handleVisibilityChange() {
    if (!document[hidden] && !scriptLoaded) {
      loadBusuanzi();
    }
  }

  if (typeof document.addEventListener !== "undefined" && typeof hidden !== "undefined") {
    document.addEventListener(visibilityChange, handleVisibilityChange, false);
  }

  // 初始加载
  if (!document[hidden]) {
    loadBusuanzi();
  }
});
</script>

{{ if not hugo.IsServer }}
{{ template "_internal/google_analytics.html" . }}
{{ end }}
{{ end }}
